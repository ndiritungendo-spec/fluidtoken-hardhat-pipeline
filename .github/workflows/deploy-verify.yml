# .github/workflows/deploy-verify.yml
name: Deploy & Verify FluidToken

on:
  push:
    branches: [ main ]
  workflow_dispatch:

# Give the job permission to push the generated lock file
permissions:
  contents: write

jobs:
  deploy-and-verify:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      NETWORK: polygon
      PRIVATE_KEY: ${{ secrets.PRIVATE_KEY }}
      POLYGON_RPC_URL: ${{ secrets.POLYGON_RPC_URL }}
      POLYGONSCAN_API_KEY: ${{ secrets.POLYGONSCAN_API_KEY }}

    steps:
      # ----------------------------------------------------------
      # 1. Checkout (full history so we can push)
      # ----------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      # ----------------------------------------------------------
      # 2. Node
      # ----------------------------------------------------------
      - name: Setup Node.js 20.19.5
        uses: actions/setup-node@v4
        with:
          node-version: 20.19.5
          cache: npm

      # ----------------------------------------------------------
      # 3. Cache node_modules (keyed by lock-file hash)
      # ----------------------------------------------------------
      - name: Cache node_modules
        id: cache
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            ~/.npm
          key: ${{ runner.os }}-npm-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-

      # ----------------------------------------------------------
      # 4. Regenerate & push package-lock.json if it is out-of-sync
      # ----------------------------------------------------------
      - name: Sync package-lock.json
        run: |
          # If lock file exists but npm ci would fail, regenerate it
          if [ -f package-lock.json ]; then
            echo "Lock file exists – checking consistency..."
            npm ci --dry-run >/dev/null 2>&1 && LOCK_OK=1 || LOCK_OK=0
          else
            LOCK_OK=0
          fi

          if [ "$LOCK_OK" = "0" ]; then
            echo "Lock file missing or out-of-sync – regenerating..."
            npm install --package-lock-only   # only writes lock file
            git config user.name "github-actions[bot]"
            git config user.email "github-actions@github.com"
            git add package-lock.json
            git commit -m "chore: sync package-lock.json (auto-generated by CI)" || echo "Nothing to commit"
            git push origin HEAD:main
            echo "Pushed fresh package-lock.json"
          else
            echo "Lock file is already in sync"
          fi

      # ----------------------------------------------------------
      # 5. Install (now guaranteed to succeed)
      # ----------------------------------------------------------
      - name: Install dependencies
        run: npm ci

      # ----------------------------------------------------------
      # 6. Install extra dev tools (solhint, eslint)
      # ----------------------------------------------------------
      - name: Install solhint
        run: npm install --save-dev solhint

      - name: Install eslint
        run: npm install --save-dev eslint

      # ----------------------------------------------------------
      # 7. Lint
      # ----------------------------------------------------------
      - name: List contracts (debug)
        run: ls -la contracts

      - name: Run solhint
        run: npx solhint 'contracts/**/*.sol'

      - name: Run eslint
        run: npx eslint scripts/**/*.js test/**/*.js

      # ----------------------------------------------------------
      # 8. Compile & flatten
      # ----------------------------------------------------------
      - name: Compile contracts
        run: npx hardhat compile --force

      - name: Flatten FluidToken.sol
        run: |
          npx hardhat flatten contracts/FluidToken.sol > contracts/FluidTokenFlattened.sol
          echo "Flattened contract created"

      # ----------------------------------------------------------
      # 9. Test
      # ----------------------------------------------------------
      - name: Run tests
        run: npx hardhat test

      # ----------------------------------------------------------
      # 10. Deploy
      # ----------------------------------------------------------
      - name: Deploy FluidToken
        id: deploy
        run: |
          echo "Deploying to $NETWORK..."
          OUTPUT=$(npx hardhat run scripts/deploy.js --network $NETWORK 2>&1)
          echo "$OUTPUT"
          ADDRESS=$(echo "$OUTPUT" | grep -i "deployed to:" | tail -1 | awk '{print $NF}')
          if [[ -z "$ADDRESS" ]]; then
            echo "ERROR: Could not extract address"
            exit 1
          fi
          echo "DEPLOYED_ADDRESS=$ADDRESS" >> $GITHUB_OUTPUT
          echo "Deployed address: $ADDRESS"

      # ----------------------------------------------------------
      # 11. Verify on Polygonscan
      # ----------------------------------------------------------
      - name: Verify contract
        env:
          POLYGONSCAN_API_KEY: ${{ secrets.POLYGONSCAN_API_KEY }}
        run: |
          npx hardhat verify --network $NETWORK \
            --constructor-args scripts/arguments.js \
            ${{ steps.deploy.outputs.DEPLOYED_ADDRESS }} \
            "contracts/FluidTokenFlattened.sol:FluidToken"

      # ----------------------------------------------------------
      # 12. Summary
      # ----------------------------------------------------------
      - name: Deployment summary
        if: success()
        run: |
          echo "FluidToken deployed & verified on $NETWORK"
          echo "Address: ${{ steps.deploy.outputs.DEPLOYED_ADDRESS }}"
          echo "Explorer: https://polygonscan.com/address/${{ steps.deploy.outputs.DEPLOYED_ADDRESS }}"

      # ----------------------------------------------------------
      # 13. Upload flattened source (optional)
      # ----------------------------------------------------------
      - name: Upload flattened source
        uses: actions/upload-artifact@v4
        with:
          name: FluidTokenFlattened-${{ github.sha }}
          path: contracts/FluidTokenFlattened.sol