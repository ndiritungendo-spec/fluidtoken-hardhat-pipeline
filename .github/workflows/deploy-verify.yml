name: Deploy & Verify FluidToken

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy-and-verify:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      # ──────────────────────────────────────────────────────────────
      - name: Checkout repository
        uses: actions/checkout@v4

      # ──────────────────────────────────────────────────────────────
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      # ──────────────────────────────────────────────────────────────
      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      # ──────────────────────────────────────────────────────────────
      - name: Lint Solidity (solhint)
        run: |
          echo "=== LINTING SOLIDITY ==="
          echo "Workspace root:"
          pwd
          echo "contracts/ contents:"
          ls -la contracts/ || echo "contracts/ not found"
          echo "Running solhint..."
          npx solhint "contracts/**/*.sol" --config .solhintrc.js

      # ──────────────────────────────────────────────────────────────
      - name: Lint JavaScript (ESLint)
        working-directory: .  # Critical: ensures .eslintrc.js is found
        run: |
          echo "=== LINTING JAVASCRIPT ==="
          echo "ESLint version:"
          npx eslint --version
          echo "Config file (.eslintrc.js):"
          cat .eslintrc.js
          echo "Linting scripts/ and test/..."
          npx eslint scripts/**/*.js test/**/*.js --quiet

      # ──────────────────────────────────────────────────────────────
      - name: Compile contracts
        run: |
          echo "=== COMPILING ==="
          npx hardhat compile --force

      # ──────────────────────────────────────────────────────────────
      - name: Flatten contract
        run: |
          echo "=== FLATTENING ==="
          npx hardhat flatten contracts/FluidToken.sol > contracts/FluidTokenFlattened.sol
          echo "Flattened → contracts/FluidTokenFlattened.sol"

      # ──────────────────────────────────────────────────────────────
      - name: Run tests
        run: |
          echo "=== TESTING ==="
          npx hardhat test

      # ──────────────────────────────────────────────────────────────
      - name: Deploy to Polygon
        id: deploy
        env:
          PRIVATE_KEY: ${{ secrets.PRIVATE_KEY }}
          POLYGON_RPC_URL: ${{ secrets.POLYGON_RPC_URL }}
        run: |
          echo "=== DEPLOYING TO POLYGON ==="
          OUTPUT=$(npx hardhat run scripts/deploy.js --network polygon 2>&1)
          echo "$OUTPUT"
          
          ADDRESS=$(echo "$OUTPUT" | grep -i "deployed to:" | tail -1 | awk '{print $NF}')
          if [ -z "$ADDRESS" ]; then
            echo "ERROR: Failed to extract deployed address!"
            echo "Full output:"
            echo "$OUTPUT"
            exit 1
          fi
          
          echo "Deployed FluidToken to: $ADDRESS"
          echo "DEPLOYED_ADDRESS=$ADDRESS" >> $GITHUB_OUTPUT

      # ──────────────────────────────────────────────────────────────
      - name: Verify on PolygonScan
        if: success()
        env:
          POLYGONSCAN_API_KEY: ${{ secrets.POLYGONSCAN_API_KEY }}
        run: |
          echo "=== VERIFYING ON POLYGONSCAN ==="
          npx hardhat verify \
            --network polygon \
            --constructor-args arguments.js \
            ${{ steps.deploy.outputs.DEPLOYED_ADDRESS }} \
            "contracts/FluidTokenFlattened.sol:FluidToken"