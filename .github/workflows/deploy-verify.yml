# .github/workflows/deploy-verify.yml
name: Deploy & Verify FluidToken

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  deploy-and-verify:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      NETWORK: polygon
      PRIVATE_KEY: ${{ secrets.PRIVATE_KEY }}
      POLYGON_RPC_URL: ${{ secrets.POLYGON_RPC_URL }}
      POLYGONSCAN_API_KEY: ${{ secrets.POLYGONSCAN_API_KEY }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      # ———————————————————————————————————————————————
      # FORCE REGENERATE package-lock.json (ONE-TIME)
      # ———————————————————————————————————————————————
      - name: Regenerate package-lock.json
        run: |
          rm -f package-lock.json
          echo "Deleted old lockfile"
          npm install --package-lock-only
          echo "Generated new lockfile"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions@github.com"
          git add package-lock.json
          git commit -m "chore: regenerate package-lock.json for Hardhat v5" || echo "No changes"
          git push origin HEAD:main
          echo "Pushed new lockfile"

      # ———————————————————————————————————————————————
      # NOW install with npm ci (will succeed)
      # ———————————————————————————————————————————————
      - name: Install dependencies
        run: npm ci

      # ———————————————————————————————————————————————
      # Rest of your steps (unchanged)
      # ———————————————————————————————————————————————
      - name: Install solhint & eslint
        run: |
          npm install --save-dev solhint eslint

      - name: Lint
        run: |
          npx solhint 'contracts/**/*.sol'
          npx eslint scripts/**/*.js test/**/*.js

      - name: Compile & Flatten
        run: |
          npx hardhat compile --force
          npx hardhat flatten contracts/FluidToken.sol > contracts/FluidTokenFlattened.sol

      - name: Test
        run: npx hardhat test

      - name: Deploy
        id: deploy
        run: |
          OUTPUT=$(npx hardhat run scripts/deploy.js --network $NETWORK)
          ADDRESS=$(echo "$OUTPUT" | grep -i "deployed to:" | tail -1 | awk '{print $NF}')
          echo "DEPLOYED_ADDRESS=$ADDRESS" >> $GITHUB_OUTPUT

      - name: Verify
        env:
          POLYGONSCAN_API_KEY: ${{ secrets.POLYGONSCAN_API_KEY }}
        run: |
          npx hardhat verify --network $NETWORK \
            --constructor-args scripts/arguments.js \
            ${{ steps.deploy.outputs.DEPLOYED_ADDRESS }} \
            "contracts/FluidTokenFlattened.sol:FluidToken"

      - name: Summary
        run: |
          echo "Deployed: ${{ steps.deploy.outputs.DEPLOYED_ADDRESS }}"
          echo "https://polygonscan.com/address/${{ steps.deploy.outputs.DEPLOYED_ADDRESS }}"