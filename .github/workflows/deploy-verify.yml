name: Deploy & Verify Polygon Mainnet

on:
  push:
    tags: ['v*']  # e.g., git tag v1.0 && git push --tags

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Deps
        run: npm ci

      - name: Compile
        run: npx hardhat compile

      - name: Deploy to Polygon
        env:
          PRIVATE_KEY: ${{ secrets.PRIVATE_KEY }}
          POLYGON_RPC_URL: ${{ secrets.POLYGON_RPC_URL }}
          FOUNDATION_WALLET: ${{ secrets.FOUNDATION_WALLET }}
          RELAYER_WALLET: ${{ secrets.RELAYER_WALLET }}
          MARKETING_WALLET: ${{ secrets.MARKETING_WALLET }}
          TEAM_WALLET: ${{ secrets.TEAM_WALLET }}
          DEV_WALLET: ${{ secrets.DEV_WALLET }}
          SIGNERS: ${{ secrets.SIGNERS }}
          REQUIRED_APPROVALS: ${{ secrets.REQUIRED_APPROVALS }}
        run: npx hardhat run scripts/deploy.js --network polygon

      - name: Verify (wait 2min)
        env:
          ETHERSCAN_API_KEY: ${{ secrets.ETHERSCAN_API_KEY }}
        run: |
          sleep 120
          npx hardhat run scripts/verify.js --network polygon
        if: success()