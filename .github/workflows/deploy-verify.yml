name: Deploy & Verify FluidToken

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write   # Required to push package-lock.json
  pull-requests: write

jobs:
  deploy-and-verify:
    runs-on: ubuntu-latest
    environment: production
    timeout-minutes: 30

    env:
      NETWORK: polygon
      PRIVATE_KEY: ${{ secrets.PRIVATE_KEY }}
      POLYGON_RPC_URL: ${{ secrets.POLYGON_RPC_URL }}
      POLYGONSCAN_API_KEY: ${{ secrets.POLYGONSCAN_API_KEY }}

    steps:
      # --------------------------------------------------------------
      # 1. Checkout (with full history for git push)
      # --------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      # --------------------------------------------------------------
      # 2. Setup Node
      # --------------------------------------------------------------
      - name: Setup Node.js 20.19.5
        uses: actions/setup-node@v4
        with:
          node-version: 20.19.5
          cache: npm

      # --------------------------------------------------------------
      # 3. Cache node_modules
      # --------------------------------------------------------------
      - name: Cache node_modules
        uses: actions/cache@v4
        id: cache
        with:
          path: |
            node_modules
            ~/.npm
          key: ${{ runner.os }}-npm-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-

      # --------------------------------------------------------------
      # 4. Generate & commit package-lock.json (if missing)
      # --------------------------------------------------------------
      - name: Ensure package-lock.json exists
        run: |
          if [ ! -f package-lock.json ]; then
            echo "package-lock.json not found â€” generating..."
            npm install
            git config user.name "github-actions[bot]"
            git config user.email "github-actions@github.com"
            git add package-lock.json
            git commit -m "chore: add package-lock.json (auto-generated by CI)" || echo "No changes to commit"
            git push origin HEAD:main
            echo "Pushed package-lock.json to main"
          else
            echo "package-lock.json already exists"
          fi

      # --------------------------------------------------------------
      # 5. Install dependencies (strict)
      # --------------------------------------------------------------
      - name: Install dependencies
        run: npm ci

      # --------------------------------------------------------------
      # 6. Install dev tools
      # --------------------------------------------------------------
      - name: Install solhint
        run: npm install --save-dev solhint

      - name: Install eslint
        run: npm install --save-dev eslint

      # --------------------------------------------------------------
      # 7. Lint
      # --------------------------------------------------------------
      - name: List contracts
        run: ls -la contracts

      - name: Run solhint
        run: npx solhint 'contracts/**/*.sol'

      - name: Run eslint
        run: npx eslint scripts/**/*.js test/**/*.js

      # --------------------------------------------------------------
      # 8. Compile & Flatten
      # --------------------------------------------------------------
      - name: Compile contracts
        run: npx hardhat compile --force

      - name: Flatten FluidToken.sol
        run: |
          npx hardhat flatten contracts/FluidToken.sol > contracts/FluidTokenFlattened.sol
          echo "Flattened contract created"

      # --------------------------------------------------------------
      # 9. Test
      # --------------------------------------------------------------
      - name: Run tests
        run: npx hardhat test

      # --------------------------------------------------------------
      # 10. Deploy
      # --------------------------------------------------------------
      - name: Deploy FluidToken
        id: deploy
        run: |
          echo "Deploying to $NETWORK..."
          OUTPUT=$(npx hardhat run scripts/deploy.js --network $NETWORK 2>&1)
          echo "$OUTPUT"
          ADDRESS=$(echo "$OUTPUT" | grep -i "deployed to:" | tail -1 | awk '{print $NF}')
          if [[ -z "$ADDRESS" ]]; then
            echo "Failed to extract address"
            exit 1
          fi
          echo "DEPLOYED_ADDRESS=$ADDRESS" >> $GITHUB_OUTPUT
          echo "Deployed: $ADDRESS"

      # --------------------------------------------------------------
      # 11. Verify on Polygonscan
      # --------------------------------------------------------------
      - name: Verify contract
        env:
          POLYGONSCAN_API_KEY: ${{ secrets.POLYGONSCAN_API_KEY }}
        run: |
          npx hardhat verify --network $NETWORK \
            --constructor-args scripts/arguments.js \
            ${{ steps.deploy.outputs.DEPLOYED_ADDRESS }} \
            "contracts/FluidTokenFlattened.sol:FluidToken"

      # --------------------------------------------------------------
      # 12. Summary
      # --------------------------------------------------------------
      - name: Deployment summary
        if: success()
        run: |
          echo "FluidToken deployed & verified!"
          echo "Address: ${{ steps.deploy.outputs.DEPLOYED_ADDRESS }}"
          echo "Explorer: https://polygonscan.com/address/${{ steps.deploy.outputs.DEPLOYED_ADDRESS }}"

      # --------------------------------------------------------------
      # 13. Upload artifact
      # --------------------------------------------------------------
      - name: Upload flattened source
        uses: actions/upload-artifact@v4
        with:
          name: FluidTokenFlattened-${{ github.sha }}
          path: contracts/FluidTokenFlattened.sol